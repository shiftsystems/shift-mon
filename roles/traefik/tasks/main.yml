- name: install packages
  block:
    - name: install packages for configuring traefik
      ansible.builtin.package:
        name: python3-passlib
        state: latest
      become: true
  rescue:
    - name: install pip
      ansible.builtin.package:
        name: python3-pip
        state: latest
      become: true

    - name: install packages for configuring traefik from pip
      ansible.builtin.pip:
        name: passlib
        state: latest
      become: true

- name: create traefik folders
  ansible.builtin.file:
    path: '{{ item }}'
    state: directory
    mode: '777'
    setype: container_file_t
  become: true
  with_items:
    - '/opt/shift-mon/traefik'
    - '/opt/shift-mon/traefik/certs'
    - '/opt/shift-mon'

- name: generate http usernames and passwords
  community.general.htpasswd:
    path: /opt/shift-mon/traefik/htpasswd
    name: '{{ item.key }}'
    password: '{{ item.value }}'
  become: true
  no_log: true
  with_dict: '{{ users }}'

- name: copy traefik config
  ansible.builtin.template:
    src: traefik.yml
    dest: /opt/shift-mon/traefik/traefik.yml
    mode: '770'
  become: true

- name: copy grafana cert
  ansible.builtin.copy:
    src: '{{ grafana.cert_path }}'
    dest: '/opt/shift-mon/traefik/certs/grafana.crt'
  when: grafana.cert_path is defined

- name: copy grafana key
  ansible.builtin.copy:
    src: '{{ grafana.key_path }}'
    dest: '/opt/shift-mon/traefik/certs/grafana.key'
  when: grafana.key_path is defined

- name: copy victoriametrics cert
  ansible.builtin.copy:
    src: '{{ victoria.cert_path }}'
    dest: '/opt/shift-mon/traefik/certs/victoria.crt'
  when: victoria.cert_path is defined

- name: copy victoriametrics key
  ansible.builtin.copy:
    src: '{{ victoria.key_path }}'
    dest: '/opt/shift-mon/traefik/certs/victoria.key'
  when: victoria.key_path is defined

- name: copy loki cert
  ansible.builtin.copy:
    src: '{{ loki.cert_path }}'
    dest: '/opt/shift-mon/traefik/certs/loki.crt'
  when: loki.cert_path is defined

- name: copy loki key
  ansible.builtin.copy:
    src: '{{ loki.key_path }}'
    dest: '/opt/shift-mon/traefik/certs/loki.key'
  when: loki.key_path is defined

- name: copy uptime-kuma cert
  ansible.builtin.copy:
    src: '{{ uptimekuma.cert_path }}'
    dest: '/opt/shift-mon/traefik/certs/uptime-kuma.crt'
  when: loki.cert_path is defined

- name: copy uptime-kuma key
  ansible.builtin.copy:
    src: '{{ uptimekuma.key_path }}'
    dest: '/opt/shift-mon/traefik/certs/uptime-kuma.key'
  when: loki.key_path is defined

- name: add Traefik log config to telegraf
  ansible.builtin.copy:
    src: telegraf-traefik.conf
    dest: /etc/telegraf/telegraf.d/traefik.conf
  become: true

- name: add logrotate config
  ansible.builtin.copy:
    src: logrotate-traefik.conf
    dest: /etc/logrotate.d/traefik.conf
  become: true
  notify: restart telegraf
