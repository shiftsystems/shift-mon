- name: Install dependencies for Meshcentral on Ubuntu based systems
  apt:
    name: "{{ ubuntu_packages }}"
    state: present
  become: true
  when: ansible_facts['os_family'] == "Debian"

- name: add repo for Redhat based systems
  yum_repository:
    name: MongoDB
    description: MongoDB
    baseurl: https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/4.4/x86_64/
    gpgcheck: yes
    gpgkey: https://www.mongodb.org/static/pgp/server-4.4.asc
    state: present
  become: true
  when: ansible_facts['os_family'] == "RedHat"

- name: Install dependencies for Meshcentral on Redhat Based Systems
  yum:
    name: "{{ redhat_packages }}"
    state: present
  become: true
  when: ansible_facts['os_family'] == "RedHat"
- name: Create Meshcentral group
  group:
    name: meshcentral
    state: present
  become: true

- name: Create Meshcentral user
  user:
    name: meshcentral
    group: meshcentral
    shell: /sbin/nologin
    state: present
  become: true

- name: Create Meshcentral directory
  file:
    name: /opt/meshcentral
    state: directory
    owner: meshcentral
    group: meshcentral
  become: true

- name: Create Meshcentral data directory
  file:
    name: /opt/meshcentral/meshcentral-data
    state: directory
    owner: meshcentral
    group: meshcentral
  become: true

- name: Create Meshcentral Images directory
  file:
    name: /opt/meshcentral/meshcentral-data/images/
    state: directory
    owner: meshcentral
    group: meshcentral
  become: true

- name: Install Meshcentral via npm
  npm:
    name: meshcentral
    path: /opt/meshcentral
  become: true

- name: Add Title Image
  copy:
    src: title.png
    dest: /opt/meshcentral/meshcentral-data/images/title.png
    owner: meshcentral
    group: meshcentral
  become: true

- name: Add Welcome Image
  copy:
    src: welcome.png
    dest: /opt/meshcentral/meshcentral-data/images/welcome.png
    owner: meshcentral
    group: meshcentral
  become: true

- name: Copy in meshcentral config file
  template:
    src: mesh-config.j2
    dest: /opt/meshcentral/meshcentral-data/config.json
  become: true

- name: Add in service file for Meshcentral
  copy:
    src: meshcentral.service
    dest: /etc/systemd/system/meshcentral.service
  become: true

- name: start and enable services required for Meshcentral on Debian Based systems
  systemd:
    name: "{{ item }}"
    state: restarted
    enabled: true
    daemon-reload: true
  become: true
  with_items: "{{ ubuntu_services }}"
  when: ansible_facts['os_family'] == "Debian"

- name: start and enable services required for Meshcentral on Redhat based Systems
  systemd:
    name: "{{ item }}"
    state: restarted
    enabled: true
    daemon-reload: true
  become: true
  with_items: "{{ redhat_services }}"
  when: ansible_facts['os_family'] == "RedHat"