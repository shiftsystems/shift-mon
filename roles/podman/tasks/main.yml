- name: Install packages on RHEL based Systems
  dnf:
    name: '{{ redhat_packages }}'
    state: latest
  become: true
  when: ansible_facts['os_family'] == 'RedHat'

- name: Install packages on debian based systems
  apt:
    name: '{{ debian_packages }}'
    state: latest
  become: true
  when: ansible_facts['os_family'] == 'Debian'

- name: install podman compose on debian based systems
  pip:
    name: podman-compose
    state: latest
  become: true
  when: ansible_facts['os_family'] == 'Debian'

- name: start and enable podman
  systemd:
    name: podman
    state: started
    enabled: true
  become: true
  when: ansible_facts['os_family'] == 'Redhat'

- name: generate compose file
  template:
    src: docker-compose.yml
    dest: /opt/shift-mon/docker-compose.yml

- name: update all container images
  shell:
    cmd: podman images | grep -v REPOSITORY | awk '{print $1}' | uniq -u | xargs -L1 podman pull 
  become: true
  ignore_errors: true

- name: run podman-compose commands
  shell:
    cmd: podman-compose down && podman-compose up -d
    chdir: /opt/shift-mon
  become: true

- name: Gather Systemd units
  service_facts:

- name: start and enable podman automatic updates
  systemd:
    name: podman-auto-update.timer
    state: started
    enabled: true
  become: true
  when: "'podman-auto-update.service' in ansible_facts.services"