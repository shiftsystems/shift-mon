- name: Gather Systemd units
  ansible.builtin.service_facts:

- name: Install Rsyslog
  ansible.builtin.package:
    name: rsyslog
    state: latest
  become: true
  when: syslog is defined and syslog == "rsyslog"
  notify: Restart Syslog

- name: Stop Telegraf
  ansible.builtin.systemd:
    name: telegraf
    state: stopped
    enabled: true
  become: true
  when: "'telegraf.service' in ansible_facts.services"

- name: Uninstall Telegraf
  ansible.builtin.package:
    name: telegraf
    state: absent
  become: true
  when: "'telegraf.service' in ansible_facts.services"

- name: Remove syslog Telegraf config
  ansible.builtin.file:
    path: /etc/rsyslog.d/50-telegraf.conf
    state: absent
  become: true
  notify: Restart Syslog

- name: Place Rsyslog config is installed when syslog is enabled
  ansible.builtin.template:
    src: "50-otelcol-contrib.conf"
    dest: /etc/rsyslog.d/50-otelcol-contrib.conf
  become: true
  when: syslog is defined and syslog == "rsyslog"
  notify: Restart Syslog

- name: Start and enable Rsyslog service
  ansible.builtin.systemd:
    name: rsyslog
    state: started
    enabled: true
  become: true
  when: syslog is defined and syslog == "rsyslog"

- name: Set processor Architecture
  ansible.builtin.set_fact:
    shiftmon_otel_architecture: "{% if ansible_userspace_architecture == 'x86_64' %}amd64{% endif %}"

- name: Install Otel Collector on Redhat based systems
  ansible.builtin.dnf:
    name: "https://github.com/open-telemetry/opentelemetry-collector-releases/releases/download/v{{ shiftmon_otel_collector_version }}/otelcol-contrib_{{ shiftmon_otel_collector_version }}_linux_{{ shiftmon_otel_architecture }}.rpm"
    state: present
    disable_gpg_check: true
  become: true
  when: ansible_facts['os_family'] == "RedHat"
  notify: Restart otel collector

- name: Install Otel Collector on Debian based systems
  ansible.builtin.apt:
    deb: "https://github.com/open-telemetry/opentelemetry-collector-releases/releases/download/v{{ shiftmon_otel_collector_version }}/otelcol-contrib_{{ shiftmon_otel_collector_version }}_linux_{{ shiftmon_otel_architecture }}.deb"
    state: present
    disable_gpg_check: true
  become: true
  when: ansible_facts['os_family'] == "Debian"
  notify: Restart otel collector

- name: Ensure override service directory
  ansible.builtin.file:
    path: /etc/systemd/system/otelcol-contrib.service.d
    state: directory
  become: true

- name: Set Otel Collector Systemd Settings
  ansible.builtin.template:
    src: override.conf
    dest: /etc/systemd/system/otelcol-contrib.service.d/override.conf
  become: true
  notify: Restart otel collector


- name: Create docker group when docker is selected
  ansible.builtin.group:
    name: docker
    state: present
  when: "'docker.service' in ansible_facts.services and 'docker' not in shiftmon_do_not_instrument"

- name: Add otel collector user to docker group when docker is installed
  ansible.builtin.user:
    name: "{{ shiftmon_otel_collector_user }}"
    groups: docker
    append: true
  become: true
  when: "'docker.service' in ansible_facts.services and 'docker' not in shiftmon_do_not_instrument"
  notify: Restart otel collector

- name: Ensure Otel collector config
  ansible.builtin.template:
    src: config.yaml
    dest: /etc/otelcol-contrib/config.yaml
  become: true
  notify: Restart otel collector

- name: Validate configuration
  ansible.builtin.shell: '/usr/bin/otelcol-contrib validate --config /etc/otelcol-contrib/config.yaml'

- name: Start and enabled Otel collector
  ansible.builtin.systemd:
    name: otelcol-contrib.service
    state: started
    enabled: true
  become: true
